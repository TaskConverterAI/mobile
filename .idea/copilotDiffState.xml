<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/FACTORY_ARCHITECTURE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/FACTORY_ARCHITECTURE.md" />
              <option name="updatedContent" value="# Архитектура фабрики ViewModel в Kotlin Multiplatform&#10;&#10;## Проблема&#10;&#10;В Kotlin Multiplatform проекте нельзя использовать Android-специфичные классы (такие как `Application`, `APPLICATION_KEY`) в `commonMain` модуле.&#10;&#10;## Решение&#10;&#10;Мы используем **Dependency Injection** паттерн для создания `ViewModel` фабрик.&#10;&#10;### Структура&#10;&#10;1. **AuthViewModel** имеет companion object с методом `createFactory`:&#10;```kotlin&#10;companion object {&#10;    fun createFactory(authRepository: AuthRepository): ViewModelProvider.Factory = viewModelFactory {&#10;        initializer {&#10;            AuthViewModel(authRepository = authRepository)&#10;        }&#10;    }&#10;}&#10;```&#10;&#10;2. **AuthViewModelFactory.kt** содержит вспомогательную функцию:&#10;```kotlin&#10;fun createAuthViewModelFactory(authRepository: AuthRepository): ViewModelProvider.Factory = &#10;    AuthViewModel.createFactory(authRepository)&#10;```&#10;&#10;3. **TaskConvertAIApp** принимает `AppContainer` как параметр:&#10;```kotlin&#10;@Composable&#10;fun TaskConvertAIApp(&#10;    appContainer: AppContainer,&#10;    viewModel: TaskConvertAIViewModel = viewModel(factory = TaskConvertAIViewModel.Factory),&#10;    navController: NavHostController = rememberNavController()&#10;)&#10;```&#10;&#10;4. При создании экранов используется:&#10;```kotlin&#10;RegistrationScreen(&#10;    authViewModel = viewModel(factory = createAuthViewModelFactory(appContainer.authRepository)),&#10;    // ...&#10;)&#10;```&#10;&#10;### Использование&#10;&#10;#### На Android стороне:&#10;&#10;В `MainActivity` (или где вызывается `TaskConvertAIApp`):&#10;&#10;```kotlin&#10;class MainActivity : ComponentActivity() {&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        val application = application as TaskConvertAIApplication&#10;        &#10;        setContent {&#10;            TaskConvertAIAppTheme {&#10;                TaskConvertAIApp(&#10;                    appContainer = application.container&#10;                )&#10;            }&#10;        }&#10;    }&#10;}&#10;```&#10;&#10;#### На iOS стороне:&#10;&#10;В iOS коде создается `AppContainer` и передается в Compose UI.&#10;&#10;## Преимущества&#10;&#10;1. ✅ **Кроссплатформенность**: Код в `commonMain` не зависит от платформо-специфичных классов&#10;2. ✅ **Тестируемость**: Легко инжектить mock-репозитории для тестов&#10;3. ✅ **Явные зависимости**: Видно, что нужно для создания ViewModel&#10;4. ✅ **Гибкость**: Можно легко изменить источник `AuthRepository`&#10;&#10;## Альтернативные подходы&#10;&#10;Если нужно полностью скрыть создание фабрики от вызывающего кода, можно использовать:&#10;- **Koin** - DI фреймворк для KMP&#10;- **Kodein** - еще один DI фреймворк&#10;- **expect/actual** паттерн для платформо-специфичного создания фабрик&#10;&#10;Но для простых случаев достаточно явной передачи зависимостей через параметры.&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/MIGRATION_TO_KMP.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/MIGRATION_TO_KMP.md" />
              <option name="updatedContent" value="# Миграция на кроссплатформенные библиотеки (KMP)&#10;&#10;## Обзор изменений&#10;&#10;Я провел анализ вашего проекта и переместил Android-специфичные библиотеки из `commonMain` в `androidMain`, заменив их на кроссплатформенные альтернативы где это возможно.&#10;&#10;## Изменения в `libs.versions.toml`&#10;&#10;### Добавленные версии:&#10;- `coil3 = &quot;3.0.4&quot;` - кроссплатформенная версия Coil&#10;- `ktor = &quot;3.0.4&quot;` - кроссплатформенная альтернатива Retrofit&#10;- `lifecycleViewmodelKmp = &quot;2.8.0&quot;` - KMP версия Lifecycle ViewModel&#10;- `navigationComposeKmp = &quot;2.8.0-alpha10&quot;` - KMP версия Navigation Compose&#10;- `kotlin-serialization` - плагин для сериализации&#10;&#10;### Добавленные библиотеки:&#10;&#10;#### Кроссплатформенные (для commonMain):&#10;1. **DataStore** (KMP):&#10;   - `androidx-datastore-preferences-core` - кроссплатформенная версия DataStore&#10;&#10;2. **Navigation** (KMP):&#10;   - `androidx-navigation-compose-kmp` - Navigation Compose для KMP&#10;&#10;3. **Lifecycle ViewModel** (KMP):&#10;   - `androidx-lifecycle-viewmodel-compose-kmp` - ViewModel Compose для KMP&#10;&#10;4. **Coil3** (изображения):&#10;   - `coil3-compose` - загрузка изображений для KMP&#10;   - `coil3-network-ktor` - использует Ktor для сетевых запросов&#10;&#10;5. **Ktor Client** (сеть):&#10;   - `ktor-client-core` - основной клиент&#10;   - `ktor-client-content-negotiation` - для JSON&#10;   - `ktor-serialization-kotlinx-json` - сериализация&#10;   - `ktor-client-android` - Android engine&#10;   - `ktor-client-darwin` - iOS engine&#10;&#10;### Добавленные плагины:&#10;- `kotlin-serialization` - необходим для kotlinx.serialization&#10;&#10;## Структура зависимостей&#10;&#10;### commonMain (Кроссплатформенные):&#10;```kotlin&#10;✅ Compose Multiplatform (compose.runtime, compose.foundation, etc.)&#10;✅ kotlinx-serialization-json&#10;✅ androidx-datastore-preferences-core (KMP версия)&#10;✅ androidx-navigation-compose-kmp&#10;✅ androidx-lifecycle-viewmodel-compose-kmp&#10;✅ coil3 (кроссплатформенный)&#10;✅ ktor-client (кроссплатформенный)&#10;✅ material-icons-extended&#10;```&#10;&#10;### androidMain (Android-специфичные):&#10;```kotlin&#10; androidx-activity-compose&#10; androidx-core-ktx&#10; androidx-lifecycle-runtime-ktx&#10; androidx-datastore-preferences (Android реализация)&#10; ktor-client-android (Android движок)&#10; retrofit, gson, okhttp (опционально, можно мигрировать на Ktor)&#10;```&#10;&#10;### iosMain (iOS-специфичные):&#10;```kotlin&#10; ktor-client-darwin (iOS движок)&#10;```&#10;&#10;## Библиотеки, которые нужно заменить&#10;&#10;### ❌ Полностью Android-специфичные (перенесены в androidMain):&#10;1. **androidx.core:core-ktx** - Android API&#10;2. **androidx.lifecycle:lifecycle-runtime-ktx** - Android lifecycle&#10;3. **androidx.activity:activity-compose** - Android Activity&#10;4. **androidx.compose.bom** - Android Compose BOM (не нужен в KMP)&#10;5. **androidx.compose.ui** (старая версия) - используйте Compose Multiplatform&#10;6. **androidx.databinding:compiler** - не нужен в большинстве случаев&#10;&#10;### ✅ Заменены на кроссплатформенные:&#10;1. **coil-compose** → **coil3-compose** (KMP)&#10;2. **androidx.navigation:navigation-compose** → **androidx.navigation:navigation-compose-kmp**&#10;3. **androidx.lifecycle:lifecycle-viewmodel-compose** → **lifecycle-viewmodel-compose-kmp**&#10;4. **androidx.datastore:datastore-preferences** → **datastore-preferences-core** (в commonMain)&#10;5. **Retrofit + OkHttp** → **Ktor Client** (опционально, Retrofit остался в androidMain)&#10;&#10;###  Миграция сетевых запросов (опционально):&#10;&#10;Если хотите полностью перейти на кроссплатформенную сеть, мигрируйте с Retrofit на Ktor:&#10;&#10;#### Было (Retrofit):&#10;```kotlin&#10;interface ApiService {&#10;    @GET(&quot;users&quot;)&#10;    suspend fun getUsers(): List&lt;User&gt;&#10;}&#10;```&#10;&#10;#### Стало (Ktor):&#10;```kotlin&#10;val client = HttpClient {&#10;    install(ContentNegotiation) {&#10;        json()&#10;    }&#10;}&#10;&#10;suspend fun getUsers(): List&lt;User&gt; {&#10;    return client.get(&quot;https://api.example.com/users&quot;).body()&#10;}&#10;```&#10;&#10;## Следующие шаги&#10;&#10;### 1. Синхронизация Gradle&#10;```bash&#10;./gradlew --stop&#10;./gradlew build&#10;```&#10;&#10;### 2. Устранение конфликтов&#10;В логах сборки видны ошибки &quot;Conflicting overloads&quot;. Это указывает на дублирование кода, вероятно между `androidMain` и `commonMain`. Нужно:&#10;- Переместить все UI компоненты в `commonMain`&#10;- Оставить в `androidMain` только Android-специфичные вещи (Activity, Android API)&#10;&#10;### 3. Обновление импортов&#10;Замените импорты в коде:&#10;&#10;```kotlin&#10;// Старый Android-специфичный импорт&#10;import androidx.compose.material3.* // из androidx&#10;&#10;// Новый кроссплатформенный импорт&#10;import androidx.compose.material3.* // из Compose Multiplatform&#10;```&#10;&#10;### 4. DataStore миграция&#10;```kotlin&#10;// В commonMain используйте:&#10;import androidx.datastore.preferences.core.*&#10;&#10;// Создание DataStore теперь платформо-специфично:&#10;// В androidMain:&#10;fun createDataStore(context: Context): DataStore&lt;Preferences&gt; = &#10;    PreferenceDataStoreFactory.create { &#10;        context.filesDir.resolve(&quot;settings.preferences_pb&quot;)&#10;    }&#10;&#10;// В iosMain:&#10;fun createDataStore(): DataStore&lt;Preferences&gt; = &#10;    PreferenceDataStoreFactory.create { &#10;        NSFileManager.defaultManager&#10;            .URLForDirectory(/*...*/)&#10;            .path + &quot;/settings.preferences_pb&quot;&#10;    }&#10;```&#10;&#10;## Преимущества изменений&#10;&#10;✅ **Код теперь работает на iOS** - большинство библиотек поддерживают iOS&#10;✅ **Меньше дублирования** - общая логика в commonMain&#10;✅ **Современные библиотеки** - Coil3, Ktor 3.x, последние KMP версии&#10;✅ **Лучшая производительность** - нативные реализации на каждой платформе&#10;✅ **Единая кодовая база** - UI и логика в одном месте&#10;&#10;## Известные проблемы&#10;&#10;1. **IDE не видит новые библиотеки** - это нормально, нужна синхронизация Gradle:&#10;   - File → Invalidate Caches / Restart&#10;   - Или просто перезапустите IDE после `./gradlew build`&#10;&#10;2. **Conflicting overloads** - у вас дублируются определения функций, скорее всего:&#10;   - Есть копии кода в `androidMain` и `commonMain`&#10;   - Нужно оставить только одну версию в `commonMain`&#10;&#10;3. **Preview аннотации** - `@Preview` работает только на Android:&#10;   ```kotlin&#10;   // В commonMain используйте expect/actual:&#10;   @OptIn(ExperimentalComposeUiApi::class)&#10;   @Composable&#10;   expect fun PreviewWrapper(content: @Composable () -&gt; Unit)&#10;   ```&#10;&#10;## Дополнительные ресурсы&#10;&#10;- [Compose Multiplatform](https://www.jetbrains.com/lp/compose-multiplatform/)&#10;- [Coil3 Documentation](https://coil-kt.github.io/coil/upgrading_to_coil3/)&#10;- [Ktor Client](https://ktor.io/docs/getting-started-ktor-client.html)&#10;- [KMP DataStore](https://developer.android.com/kotlin/multiplatform/datastore)&#10;- [Navigation Compose KMP](https://www.jetbrains.com/help/kotlin-multiplatform-dev/compose-navigation-routing.html)&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/shared/src/androidMain/kotlin/com/example/taskconvertaiapp/shared/network/AuthApiService.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/shared/src/androidMain/kotlin/com/example/taskconvertaiapp/shared/network/AuthApiService.kt" />
              <option name="originalContent" value="package com.example.taskconvertaiapp.shared.network&#10;&#10;import com.example.taskconvertaiapp.shared.model.SignInUserRequest&#10;import com.example.taskconvertaiapp.shared.model.SignInUserResponse&#10;import com.example.taskconvertaiapp.shared.model.SignUpUserRequest&#10;import com.example.taskconvertaiapp.shared.model.SignUpUserResponse&#10;import retrofit2.Response&#10;import retrofit2.http.Body&#10;import retrofit2.http.POST&#10;&#10;interface AuthApiService {&#10;    @POST(&quot;auth/register&quot;)&#10;    suspend fun signUp(@Body user: SignUpUserRequest): Response&lt;SignUpUserResponse&gt;&#10;&#10;    @POST(&quot;auth/login&quot;)&#10;    suspend fun signIn(@Body user: SignInUserRequest): Response&lt;SignInUserResponse&gt;&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.taskconvertaiapp.shared.network&#10;&#10;import com.example.taskconvertaiapp.shared.model.SignInUserRequest&#10;import com.example.taskconvertaiapp.shared.model.SignInUserResponse&#10;import com.example.taskconvertaiapp.shared.model.SignUpUserRequest&#10;import com.example.taskconvertaiapp.shared.model.SignUpUserResponse&#10;import retrofit2.Response&#10;import retrofit2.http.Body&#10;import retrofit2.http.POST&#10;&#10;interface AuthApiService {&#10;    @POST(&quot;auth/register&quot;)&#10;    suspend fun signUp(@Body user: SignUpUserRequest): Response&lt;SignUpUserResponse&gt;&#10;&#10;    @POST(&quot;auth/login&quot;)&#10;    suspend fun signIn(@Body user: SignInUserRequest): Response&lt;SignInUserResponse&gt;&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/shared/src/androidMain/kotlin/com/example/taskconvertaiapp/shared/ui/screens/auth/AuthViewModelFactory.android.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/shared/src/androidMain/kotlin/com/example/taskconvertaiapp/shared/ui/screens/auth/AuthViewModelFactory.android.kt" />
              <option name="updatedContent" value="package com.example.taskconvertaiapp.shared.ui.screens.auth&#10;&#10;import android.content.Context&#10;import androidx.datastore.core.DataStore&#10;import androidx.datastore.preferences.core.Preferences&#10;import androidx.datastore.preferences.preferencesDataStore&#10;import com.example.taskconvertaiapp.shared.data.DefaultAppContainer&#10;import com.example.taskconvertaiapp.shared.data.auth.AuthRepository&#10;&#10;// DataStore setup&#10;private const val AUTH_PREFERENCES = &quot;auth_preferences&quot;&#10;private val Context.dataStore: DataStore&lt;Preferences&gt; by preferencesDataStore(&#10;    name = AUTH_PREFERENCES&#10;)&#10;&#10;// Global application context holder&#10;private lateinit var applicationContext: Context&#10;&#10;// Initialize function to be called from Android Application class&#10;fun initializeAuthRepository(context: Context) {&#10;    applicationContext = context.applicationContext&#10;}&#10;&#10;// Actual implementation for Android&#10;actual fun provideAuthRepository(): AuthRepository {&#10;    val container = DefaultAppContainer(applicationContext.dataStore)&#10;    return container.authRepository&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/shared/src/iosMain/kotlin/com/example/taskconvertaiapp/shared/ui/screens/auth/AuthViewModelFactory.ios.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/shared/src/iosMain/kotlin/com/example/taskconvertaiapp/shared/ui/screens/auth/AuthViewModelFactory.ios.kt" />
              <option name="updatedContent" value="package com.example.taskconvertaiapp.shared.ui.screens.auth&#10;&#10;import com.example.taskconvertaiapp.shared.data.auth.AuthRepository&#10;import com.example.taskconvertaiapp.shared.data.auth.UserAuthPreferencesRepository&#10;import com.example.taskconvertaiapp.shared.data.createAuthRepository&#10;import androidx.datastore.core.DataStore&#10;import androidx.datastore.preferences.core.Preferences&#10;&#10;// Platform-specific DataStore instance&#10;private lateinit var dataStoreInstance: DataStore&lt;Preferences&gt;&#10;&#10;// Initialize function to be called from iOS&#10;fun initializeAuthRepository(dataStore: DataStore&lt;Preferences&gt;) {&#10;    dataStoreInstance = dataStore&#10;}&#10;&#10;// Actual implementation for iOS&#10;actual fun provideAuthRepository(): AuthRepository {&#10;    val userAuthPreferencesRepository = UserAuthPreferencesRepository(dataStoreInstance)&#10;    return createAuthRepository(userAuthPreferencesRepository)&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>